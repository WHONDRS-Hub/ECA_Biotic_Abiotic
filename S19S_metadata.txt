#Correlations with metadata and climate variables

metadata.all1 = read.csv(paste0(input.path,"WHONDRS_S19S_ESSDIVE_Metadata.csv"))
#, header = F, stringsAsFactors = F) #Import metadata downloaded from ESS-Dive

# Removing the first row of and adjusting the dataframe so the second row is the column headers 
metadata.all2 = metadata.all1[-1,]
# 
# colnames(metadata.all2) = metadata.all2[1,]
# metadata.all2 = metadata.all2[-1, ] 
# colnames(metadata.all2) = gsub (" ", "_", colnames(metadata.all2))

climate.all = read.csv(paste0(input.path,"WHONDRS_ClimVariables.csv"))
metadata.all = merge(metadata.all2,climate.all, by = "Sample_ID")


# Select only the columns from the metadata that contain the following information
relevant.columns = c("Sample_ID","Stream_Name","City","State_or_Province", "Country","US_Longitude_dec.deg","US_Latitude_dec.deg" ,"PET_mm_per_yr","AET_mm_per_yr","MAT_degrees_C", "MAP_mm_per_yr", "TAR_degrees_C","Distance_m")




metadata.all.final = as.data.frame(matrix(NA, ncol = length(relevant.columns), nrow = nrow (metadata.all)))
for (i in 1:length(relevant.columns)){
  temp = metadata.all[which(colnames(metadata.all) == relevant.columns[i],)]
  metadata.all.final[i] = temp
  colnames(metadata.all.final)[i] = colnames(metadata.all[which(colnames(metadata.all) == relevant.columns[i],)])
}

metadata.all = metadata.all.final

meta=data.frame(matrix(NA, ncol=(ncol(metadata.all)+ncol(agregate.results)), nrow = 1))
colnames(meta)=c("Sample_ID", "MeanGFE0perCmol","MedianGFE0perCmol","MeanGFE0perCompmol","MedianGFE0perCompmol","MeanGFEperCmol","MedianGFEperCmol","MeanGFEperCompmol","MedianGFEperCompmol","Mean0lambda","Median0lambda","Meanlambda","Medianlambda","No.replicates", "Sample_ID","Stream_Name","City","State_or_Province", "Country","US_Longitude_dec.deg","US_Latitude_dec.deg","PET_mm_per_yr","AET_mm_per_yr","MAT_degrees_C", "MAP_mm_per_yr", "TAR_degrees_C","Distance_m")

for (i in 1:nrow(agregate.results)){
  temp = str_extract(agregate.results$Sample_ID[i], "S19S_[0-9]{4}")
  col= metadata.all[which(metadata.all$Sample_ID == temp),] # Mol data for a given sample
  
  datmeta=cbind(agregate.results[i,],col)
  meta=rbind(meta,datmeta)
}

meta.mix=meta[-1,]
metadata.us=subset(meta.mix, meta.mix$Country=="USA")
metadata.us.cont= metadata.us[!grepl(pattern = "Puerto Rico",x = metadata.us$State_or_Province),]
metadata.CONUS= metadata.us.cont[!grepl(pattern = "Alaska",x = metadata.us.cont$State_or_Province),]
metadata.north=subset(meta.mix, meta.mix$Country %in% c("USA","Canada"))
metadata.global=meta.mix

#Separate sediments from water
#US
metadata.CONUS.sediments=metadata.CONUS[grep(pattern = "Sed_Field",x = metadata.CONUS$Sample_ID),]
metadata.CONUS.water=metadata.CONUS[!grepl(pattern = "Sed_Field",x = metadata.CONUS$Sample_ID),]


metadata.CONUS.sediments$Type= "Sediments"
metadata.CONUS.water$Type= "Surface_Water"

metadata.CONUS.all= rbind(metadata.CONUS.sediments,metadata.CONUS.water)